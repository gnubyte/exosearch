<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="/static/Exosearch.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <title>ES - Search and Retrieve Contents</title>
  <style>
    .container {
      margin-top: 50px;
    }
  </style>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head>
<body>
  <div id="app" class="container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/">Exosearch</a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="/upload">Upload Files</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/search">Search</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/settings"><i class="fas fa-cog">Settings</i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout">logout</a>
          </li>
        </ul>
      </div>
    </nav>

    <h1>Search and Retrieve Contents</h1>

    <div class="row">
      <div class="col-md-4">
        <form id="searchForm" @submit.prevent="searchContents">
          <div class="form-group">
            <label for="indexInput">Index:</label>
            <input type="text" class="form-control" v-model="index" placeholder="Enter index">
          </div>
          <div class="form-group">
            <label for="sourceInput">Source: <i>(optional)</i></label>
            <input type="text" class="form-control" v-model="source" placeholder="Enter source">
          </div>
          <div class="form-group">
            <label for="hostInput">Host:<i>(optional)</i></label>
            <input type="text" class="form-control" v-model="host" placeholder="Enter host">
          </div>
          <div class="form-group">
            <label for="keywordsInput">Keywords:<i>(optional)</i></label>
            <input type="text" class="form-control" v-model="keywords" placeholder="Enter keywords">
          </div>
          <div class="form-group">
            <label for="startDateTimePicker">Start Date and Time:</label>
            <input type="text" v-model="startDateTime" class="form-control" ref="startDateTimePicker" placeholder="Select start date and time">
          </div>
          <div class="form-group">
            <label for="endDateTimePicker">End Date and Time:</label>
            <input type="text" v-model="endDateTime" class="form-control" ref="endDateTimePicker" placeholder="Select end date and time">
          </div>
          <div class="form-group">
            <label for="linebreakerInput">Line Breaker (Regex):<i>(optional)</i></label>
            <input type="text" class="form-control" v-model="linebreaker" placeholder="Enter line breaker regex">
          </div>
          <button type="submit" class="btn btn-primary">Search</button>
        </form>
      </div>

      <div class="col-md-8">
        <table id="searchResultsTable" class="table" style="width:100%">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Event Number</th>
              <th>Event Data</th>
              <th>Host</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="result in searchResults" :key="result.eventNumber">
              <td>{{ result.addedAt }}</td>
              <td>{{ result.eventNumber }}</td>
              <td>{{ result.eventData }}</td>
              <td>{{ result.host }}</td>
              <td>{{ result.source }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-4">
        <table id="metadataTable" class="table">
          <thead>
            <tr>
              <th>Metadata</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Pages</td>
              <td id="totalPages">{{ totalPages }}</td>
            </tr>
            <tr>
              <td>Total Events</td>
              <td id="totalEvents">{{ totalEvents }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>-->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


  <script>
    new Vue({
      el: '#app',
      data: {
        index: '',
        source: '',
        host: '',
        keywords: '',
        startDateTime: '',
        endDateTime: '',
        searchResults: [],
        fields: [
          { key: 'addedAt', label: 'Timestamp' },
          { key: 'eventNumber', label: 'Event Number' },
          { key: 'eventData', label: 'Event Data' },
          { key: 'host', label: 'Host' },
          { key: 'source', label: 'Source' },
        ],
        currentPage: 1,
        perPage: 10,
        totalPages: 0,
        totalEvents: 0,
      },
      methods: {
        searchContents() {
          const url = '/api/search/searchandretrieve';
          const params = new URLSearchParams({
            index: this.index,
            source: this.source,
            host: this.host,
            keywords: this.keywords,
            datetimeRange: `${this.startDateTime} - ${this.endDateTime}`,
            linebreaker: this.linebreaker,
          });

          fetch(`${url}?${params}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
            },
          })
            .then(response => response.json())
            .then(data => {
              this.searchResults = data;
              this.totalPages = Math.ceil(data.length / this.perPage);
              this.totalEvents = data.length;
            })
            .catch(error => {
              console.error('Error searching and retrieving file contents:', error);
              alert('Error searching and retrieving file contents.');
            });
        }
      },
      mounted() {
        const startDateTimePicker = this.$refs.startDateTimePicker;
        const endDateTimePicker = this.$refs.endDateTimePicker;
        
        const options = {
          enableTime: true,
          time_24hr: true,
          dateFormat: 'Y-m-d H:i:S',
          onClose: () => {
            this.startDateTime = moment(startDateTimePicker.value).format('YYYY-MM-DD HH:mm:ss');
            this.endDateTime = moment(endDateTimePicker.value).endOf('day').format('YYYY-MM-DD HH:mm:ss');
          }
        };

        flatpickr(startDateTimePicker, options);
        flatpickr(endDateTimePicker, options);
      },
    });
  </script>
</body>
</html>
